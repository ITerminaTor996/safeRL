# 观测空间改进需求规格

## 背景

当前项目是一个基于形式化方法的安全强化学习框架，核心设计原则：
- **Safety（安全）**：用形式化方法保证（硬约束）—— 绝对不可违反
- **Task（任务）**：交给 RL 学习（软目标）—— 策略可灵活学习

### 当前问题

1. **观测空间设计**：当前观测为 `[agent_row, agent_col, goal_row - agent_row, goal_col - agent_col]`
   - 包含了目标相对位置信息
   - 问题：如果有多个目标怎么办？观测维度会变化

2. **大地图学习困难**：15×15 地图训练 100000 步仍无法到达目标
   - 原因：缺乏局部感知，智能体不知道周围环境

3. **泛化性考虑**：目标信息硬编码在观测中，换目标需要重新训练

---

## 用户故事

### US-1: 局部感知能力
**作为** 一个 RL 智能体  
**我希望** 能感知周围 N×N 格的环境信息  
**以便** 在复杂地图中做出更好的决策

**验收标准：**
- [x] 观测包含以智能体为中心的 N×N 局部视野
- [x] 局部视野包含墙、空地、目标、边界等信息
- [x] N 可配置（默认 5×5）
- [x] 边界外的格子有特殊标记 (值=3)

### US-2: 目标方向信息
**作为** 一个 RL 智能体  
**我希望** 知道目标的大致方向  
**以便** 在看不到目标时也能朝正确方向移动

**验收标准：**
- [x] 观测包含目标相对方向信息
- [x] 方向信息为归一化向量 [dy, dx]
- [ ] 支持多目标场景（待实现）

### US-3: 多目标支持
**作为** 一个用户  
**我希望** 系统能支持多个目标点  
**以便** 定义更复杂的任务

**验收标准：**
- [ ] 地图支持多个目标点标记
- [ ] 观测空间能表示多目标信息
- [ ] 到达任一目标即算完成（或按顺序到达）

### US-4: 安全层兼容
**作为** 安全监控系统  
**我希望** 观测空间改变后安全层仍能正常工作  
**以便** 保持形式化安全保证

**验收标准：**
- [x] SafeEnvWrapper 正确获取智能体位置（使用 agent_pos）
- [x] 安全监控不依赖观测空间格式
- [x] 动作过滤功能正常

---

## 设计方案

### 方案 A：局部视野 + 目标方向（推荐）

```
观测空间 = [局部视野 (N×N), 目标方向信息]

局部视野编码：
- 0: 空地
- 1: 墙
- 2: 目标
- 3: 边界外

目标方向：
- 单目标：[dx, dy] 归一化方向向量
- 多目标：最近目标的方向，或所有目标方向的列表
```

**优点：**
- 局部感知帮助避障
- 目标方向提供全局导航信息
- 观测维度固定，不随地图大小变化

**缺点：**
- 观测维度较大（N×N + 2）
- 需要 CNN 或更复杂的网络结构

### 方案 B：纯局部视野（简化版）

```
观测空间 = 局部视野 (N×N) 展平

如果目标在视野内，智能体能看到
如果目标不在视野内，需要探索
```

**优点：**
- 最简单，最符合"真实感知"
- 观测维度固定

**缺点：**
- 目标不在视野内时学习困难
- 可能需要更长训练时间

### 方案 C：保持当前设计 + 多目标扩展

```
单目标：[x, y, dx, dy]
多目标：[x, y, dx1, dy1, dx2, dy2, ...] 或 [x, y, nearest_dx, nearest_dy]
```

**优点：**
- 改动最小
- 简单地图效果好

**缺点：**
- 缺乏局部感知
- 多目标时维度不固定

---

## 推荐实现路径

### 阶段 1：局部视野基础实现
1. 修改 `env.py` 添加局部视野生成方法
2. 更新观测空间定义
3. 保持目标方向信息（兼容当前设计）

### 阶段 2：网络结构适配
1. 如果使用 CNN：设计合适的网络结构
2. 如果使用 MLP：展平局部视野

### 阶段 3：多目标支持
1. 修改地图解析支持多目标
2. 更新目标方向计算（最近目标）
3. 更新终止条件

### 阶段 4：测试验证
1. 在简单地图验证功能
2. 在复杂地图测试学习效果
3. 对比实验：有/无局部视野

---

## 配置示例

```yaml
# config.yaml 扩展

observation:
  type: "local_view"          # local_view | position_only | hybrid
  local_view_size: 5          # N×N 局部视野大小
  include_goal_direction: true # 是否包含目标方向
  goal_direction_type: "relative"  # relative | normalized | discrete

task:
  multi_goal: false           # 是否多目标
  goal_order: "any"           # any | sequential
```

---

## 文件修改清单

| 文件 | 修改内容 |
|------|----------|
| `safe_rl_drone/env.py` | 添加局部视野生成，更新观测空间 |
| `safe_rl_drone/wrappers/safe_env_wrapper.py` | 确保兼容新观测空间 |
| `config.yaml` | 添加观测空间配置项 |
| `main.py` | 适配新配置 |
| `tests/test_observation.py` | 新增观测空间测试 |

---

## 版本信息

- 创建日期：2026-01-04
- 状态：草案
- 优先级：高
